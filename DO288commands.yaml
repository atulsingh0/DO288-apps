# DO288 commands

# CH03-Ex1
#---------------

oc new-project external-registry

podman login quay.io

skopeo copy \
oci:/home/student/DO288/labs/external-registry/ubi-sleep \
docker://quay.io/${RHT_OCP4_QUAY_USER}/ubi-sleep:1.0

oc create secret docker-registry quayio \
--docker-server=quay.io \
--docker-username=atulsingh0 \
--docker-password=

oc secrets link default quayio 
oc secrets link default quayio --for=pull


oc import-image ubi-sleep:latest --from=quay.io/atulsingh0/ubi-sleep:1.0 --confirm
oc new-app --name=ubi-sleep \
-i ubi-sleep


oc delete project external-registry


# CH03-Ex2
#---------------

oc new-project me-common

oc get route -n openshift-image-registry

TOKEN=$(oc whoami -t)
USERNAME=$(oc whoami)


skopeo copy \
--dcreds=$USERNAME:$TOKEN \
oci:/home/student/DO288/labs/external-registry/ubi-sleep \
docker://default-route-openshift-image-registry.apps.na45.prod.nextcle.com/me-common/ubi-sleep:latest 

oc policy add-role-to-user system:image-puller ${USERNAME} -n me-common
oc get rolebindings -n me-common

podman login default-route-openshift-image-registry.apps.na45.prod.nextcle.com -u $USERNAME -p $TOKEN
podman pull default-route-openshift-image-registry.apps.na45.prod.nextcle.com/me-common/ubi-sleep:latest


oc delete project me-common


# CH03-Ex3
#-------------------

skopeo inspect docker://quay.io/redhattraining/hello-world-nginx

skopeo copy \
--dcreds=atulsingh0:'V!sual@11' \
docker://quay.io/redhattraining/hello-world-nginx \
docker://quay.io/atulsingh0/hello-world-nginx 

skopeo inspect docker://quay.io/redhattraining/hello-world-nginx --creds=atulsingh0:'V!sual@11'


oc create secret docker-registry quayio \
--docker-server=quay.io \
--docker-username=atulsingh0 \
--docker-password='V!sual@11'

oc secrets link default quayio --for=pull

oc import-image hello-world-nginx:latest --from=quay.io/redhattraining/hello-world-nginx --confirm

oc new-app --name hello \
-i hello-world-nginx:latest
oc expose svc/hello
oc get route


# CH03-lab
#-------------------

skopeo copy \
oci:php-info \
docker://quay.io/atulsingh0/php-info:latest \
--dcreds=atulsingh0:'V!sual@11'

skopeo inspect --creds=atulsingh0:'V!sual@11' \
docker://quay.io/atulsingh0/php-info:latest

oc import-image php-info:latest \
--reference-policy=local \
--from=quay.io/atulsingh0/php-info:latest \
--confirm

oc new-project expose-image
oc policy add-role-to-group system:image-puller \
system:serviceaccounts:expose-image -n me-common


oc new-app --name=php-info \
-i me-common/php-info

oc expose svx/php-info \
oc get route php-info -o jsonpath='{ .spec.host }'

curl $(oc get route php-info -o jsonpath='{ .spec.host }')

oc delete project expose-image


# CH02-Ex1
#-------------------

oc new-project container-image

oc new-app --as-deployment-config --name hola \
https://github.com/${RHT_OCP4_GITHUB_USER}/DO288-apps#develop \
--context-dir container-build

oc expose svc/hola

oc logs -f bc/hola

oc delete all -l app=hola

# edit the dockerfile
# change n expose port
# change ownership of files
# set a non-root user
# redeploy

curl $(oc get route hola -o jsonpath='{ .spec.host }')


# CH02-Ex2
#-------------------

oc new-app --as-deployment-config --name myapp \
--build-env npm_config_registry=http://${RHT_OCP4_NEXUS_SERVER}/repository/nodejs \
nodejs:12~https://github.com/${RHT_OCP4_GITHUB_USER}/DO288-apps#develop \
--context-dir app-config

oc expose svc/myapp

oc logs -f bc/myapp 

curl $(oc get route myapp -o jsonpath='{.spec.host}')

oc create configmap myappcm --from-literal APP_MSG="this is me learning DO288"
oc create secret generic myappsec --from-file=./myapp.sec

oc set env dc/myapp --from=configmap/myappcm 
oc set volume dc/myapp --name myappsec \
--add \
-m /opt/app-root/secure \
-t secret \
--secret-name=myappsec

oc delete all -l app=myapp


# CH02-lab
#-------------------

oc new-app --as-deployment-config --name elvis \
https://github.com/${RHT_OCP4_GITHUB_USER}/DO288-apps#develop \
--context-dir hello-java

oc expose svc/elvis
oc logs -f bc/elvis

curl $(oc get route elvis -o jsonpath='{.spec.host}')/api/hello

oc create configmap elviscm --from-literal APP_MSG='This is magic'
oc set env dc/elvis --from configmap/elviscm

oc rollout latest elvis


# CH04-Ex1
#-------------------


oc new-app --as-deployment-config --name jhost \
--build-env MAVEN_MIRROR_URL=http://${RHT_OCP4_NEXUS_SERVER}/repository/java \
-i redhat-openjdk18-openshift:1.5 \
https://github.com/${RHT_OCP4_GITHUB_USER}/DO288-apps#develop \
--context-dir java-serverhost

oc expose svc/jhost
oc logs -f bc/jhost

curl $(oc get route jhost -o jsonpath='{.spec.host}')


# CH04-Ex2
#-------------------

skopeo copy \
--dcreds=atulsingh0:'V!sual@11' \
docker-archive:./php-70-rhel7-original.tar.gz \
docker://quay.io/${RHT_OCP4_QUAY_USER}/php-70-rhel7:latest


podman login --authfile ../../auth.json quay.io

oc create secret generic quayio \
--type=kubernetes.io/dockerconfigjson \
--from-file=.dockerconfigjson=../../auth.json

oc secrets link default quayio --for=pull
oc secrets link builder quayio --for=pull
oc secrets link default quayio 
oc secrets link builder quayio 

oc import-image php-base --from  quay.io/${RHT_OCP4_QUAY_USER}/php-70-rhel7:latest --confirm


oc new-app --name trigger \
--as-deployment-config \
php-base~https://github.com/${RHT_OCP4_GITHUB_USER}/DO288-apps#develop \
--context-dir trigger-builds

oc logs -f bc/trigger

oc expose svc/trigger
curl $(oc get route trigger -o jsonpath='{.spec.host}')


skopeo copy \
--screds=atulsingh0:'V!sual@11' \
--dcreds=atulsingh0:'V!sual@11' \
docker://quay.io/${RHT_OCP4_QUAY_USER}/php-70-rhel7:latest \
docker://quay.io/${RHT_OCP4_QUAY_USER}/php-70-rhel7:v1 


skopeo copy \
--dcreds=atulsingh0:'V!sual@11' \
docker-archive:php-70-rhel7-newer.tar.gz \
docker://quay.io/${RHT_OCP4_QUAY_USER}/php-70-rhel7:latest

skopeo copy \
--screds=atulsingh0:'V!sual@11' \
--dcreds=atulsingh0:'V!sual@11' \
docker://quay.io/${RHT_OCP4_QUAY_USER}/php-70-rhel7:latest \
docker://quay.io/${RHT_OCP4_QUAY_USER}/php-70-rhel7:v2


oc import-image php-base 
oc logs -f bc/trigger
curl $(oc get route trigger -o jsonpath='{.spec.host}')



oc delete all -l app=trigger


# CH04-Ex3
#-------------------

oc status

oc new-app --as-deployment-config --name hook \
php:7.3~http://github.com/${RHT_OCP4_GITHUB_USER}/DO288-apps \
--context-dir post-commit

oc expose svc/hook



oc describe bc/hook | grep Post

oc start-build bc/hook -F

oc set env bc/hook DEVELOPER="Your Name"
oc set env bc/hook --list
oc start-build bc/hook -F

curl http://builds-for-managers-atul-haridoss-abc-com-post-commit.apps.na45.prod.nextcle.com/


# copying the imgae
skopeo copy \
-dcreds=atulsingh0:'V!sual@11' \
docker://quay.io/repository/redhattraining/builds-for-managers:latest \
docker://quay.io/repository/atulsingh0/builds-for-managers:latest 



# CH04-lab
#-------------------

oc new-app --as-deployment-config \
--name simple \
--build-env npm_config_registry=http://${RHT_OCP4_NEXUS_SERVER}/repository/nodejs \
nodejs~https://github.com/${RHT_OCP4_GITHUB_USER}/DO288-apps#develop \
--context-dir build-app

oc expose svc/simple

oc describe bc/simple
oc get bc/simple -o yaml


# CH05-Ex1
#-------------------


oc new-app --as-deployment-config \
--name bonjour \
httpd:2.4~https://github.com/${RHT_OCP4_GITHUB_USER}/DO288-apps#develop \
--context-dir s2i-scripts


# CH05-Ex2   
#-------------------

s2i version
s2i create s2i-do288-httpd s2i-do288-httpd

podman build -t quay.io/atulsingh0/s2i-do288-httpd .
s2i build test/test-app/ quay.io/atulsingh0/s2i-do288-httpd s2i-httpd-app --as-dockerfile s2i-httpd-app/Dockerfile

podman build -t s2i-httpd-app -f s2i-httpd-app/Dockerfile


oc new-app --name s2i-httpd-app \
s2i-do288-httpd~https://github.com/atulsingh0/DO288-apps#develop \
--context-dir s2i-do288-httpd/test/test-app



# CH05-lab
#-------------------

podman build -t quay.io/atulsingh0/s2i-do288-go .
s2i build test/test-app/ quay.io/atulsingh0/s2i-do288-go s2i-go-app --as-dockerfile s2i-go-app/Dockerfile

podman build -t s2i-go-app -f s2i-go-app/Dockerfile

podman run -d -p 9000:8080 s2i-go-app

podman push quay.io/atulsingh0/s2i-do288-go
oc import-image s2i-do288-go --from=quay.io/atulsingh0/s2i-do288-go --confirm

oc new-app --name greet --as-deployment-config \
s2i-do288-go~https://github.com/atulsingh0/DO288-apps#develop \
--context-dir custom-s2i/test/test-app

- now making changed in run file inside test app 


# CH06-Ex1
#-------------------

oc get is,bc,dc,svc,route,pcv -o yaml -o export > dirty.yaml

 - clean the yaml files by removing annotations, field & status value
 - No of ocp object should be equal to no of object deployed.
 - No of IS should be equal to no of DC



# CH06-lab
#-------------------

oc new-app  --as-deployment-config --name todo --file ./todo-template-fix.yaml \
    -p APP_GIT_URL=https://github.com/atulsingh0/DO288-apps \
    -p NPM_PROXY=http://nexus-common.apps.na45.prod.nextcle.com/repository/nodejs \
    -p PASSWORD=mypass \
    -p CLEAN_DATABASE=true \
    -p SECRET=atul1234 \
    -p HOSTNAME=todo-container-image.apps.na45.prod.nextcle.com



# CH07-Ex1
#-------------------    

oc new-app --as-deployment-config \
--name probes --build-env \
npm_config_registry=http://nexus-common.apps.na45.prod.nextcle.com/repository/nodejs \
nodejs:12~https://github.com/atulsingh0/DO288-apps \
--context-dir probes


oc get dc/probes -o jsonpath='{.spec.strategy.type}{"\n"}'
oc get dc/probes -o jsonpath='{.spec.strategy.rollingParams}{"\n"}'

oc patch dc/probes -p '{"spec":{"strategy":{"type":"Recreate"}}}'
oc patch dc/probes -p '[{"op":"remove", "path":"/spec/strategy/rollingParams"}]' --type json

oc set probe dc/probes --liveness \
 --get-url=http://:8080/healthz \
 --initial-delay-seconds=2 --timeout-seconds=2

oc set probe dc/probes --readiness \
 --get-url=http://:8080/ready \
 --initial-delay-seconds=2 --timeout-seconds=2


# CH07-Ex2
#-------------------  

oc new-app --as-deployment-config --name mysql \
-e MYSQL_USER=test -e MYSQL_PASSWORD=redhat -e MYSQL_DATABASE=testdb \
--docker-image registry.access.redhat.com/rhscl/mysql-57-rhel7

oc get dc/mysql -o jsonpath='{.spec.strategy.type}{"\n"}'
oc get dc/mysql -o jsonpath='{.spec.strategy.rollingParams}{"\n"}'

oc set triggers dc/mysql --remove-all

oc patch dc/mysql -p '{"spec":{"strategy":{"type":"Recreate"}}}'
oc patch dc/mysql -p '[{"op":"remove", "path":"/spec/strategy/rollingParams"}]' --type json


- import data:
  POD_NAME=$(oc get pods -l deploymentconfig=mysql -o name)
  oc port-forward $POD_NAME 33306:3306 &
  RC=$!
  mysql -utest -predhat -h127.0.0.1 -P 33306 testdb < users.sql
  kill $RC

- ./post-hook.sh
  oc patch dc/mysql --patch '{"spec":{"strategy":{"recreateParams":{"post":{"failurePolicy": "Abort","execNewPod":{"containerName":"mysql","command":["/bin/sh","-c","curl -L -s https://github.com/RedHatTraining/DO288-apps/releases/download/OCP-4.1-1/import.sh -o /tmp/import.sh&&chmod 755 /tmp/import.sh&&/tmp/import.sh"]}}}}}}'

  oc rollout latest dc/mysql

  oc set env dc/mysql HOOK_RETRIES=5
  oc rollout latest dc/mysql


# CH07-Ex3
#-------------------    

oc new-app --as-deployment-config \
--name quip --build-env \
MAVEN_MIRROR_URL=http://nexus-common.apps.na45.prod.nextcle.com/repository/java \
redhat-openjdk18-openshift:1.5~https://github.com/atulsingh0/DO288-apps \
--context-dir quip

oc set probe dc/quip --liveness \
--get-url=http://:8080/ready \
--initial-delay-seconds=30 --timeout-seconds=2

oc set probe dc/quip --readiness \
--get-url=http://:8080/ready \
--initial-delay-seconds=30 --timeout-seconds=2


oc start-build quip -F
oc rollback dc/quip



# CH07-lab
#-------------------  


oc new-app --as-deployment-config \
--name scale \
php~https://github.com/atulsingh0/DO288-apps \
--context-dir php-scale

oc get dc/scale -o jsonpath='{.spec.strategy.type}{"\n"}'


# CH08-Ex1
#-------------------  

oc new-project me-dev
oc new-project me-qa
oc new-project me-common

oc new-app --name jenkins --template=jenkins-ephemeral


oc policy add-role-to-user edit system:serviceaccount:me-common:jenkins -n me-dev
oc policy add-role-to-user edit system:serviceaccount:me-common:jenkins -n me-qa


# CH08-Ex2/lab
#-------------------  


# LAB 1
# -----------------------


podman build -t quay.io/atulsingh0/front-end:latest .
podman push quay.io/atulsingh0/front-end:latest

oc new-project me-lab

oc create secret docker-registry quayio \
--docker-server=quay.io \
--docker-username=atulsingh0 \
--docker-password='V!sual@11'

oc secrets link builder quayio --for=pull
oc secrets link default quayio --for=pull

oc import-image frontend:latest --from=quay.io/atulsingh0/front-end:latest \
--reference-policy=local \
--confirm

oc policy add-role-to-group system:image-puller system:serviceaccounts:me-dev -n me-common

oc project me-dev

oc new-app --name=frontend \
--as-deployment-config \
-e BACKEND_HOST=api.example.com \
-i me-lab/front-end:latest


# LAB 2
# -----------------------

oc create secret generic tododb \
--from-literal user=todoapp \
--from-literal password=mypass 


oc new-app --name=mysql \
--as-deployment-config \
-e MYSQL_DATABASE=todo \
-e MYSQL_USER=todoapp \
-e MYSQL_PASSWORD=mypass \
--docker-image=registry.access.redhat.com/rhscl/mysql-57-rhel7

oc set env dc/mysql --from=secret/tododb --prefix=MYSQL_

-- 

oc create configmap todoapp \
--from-literal init=true 

oc new-app --name=backend \
--as-deployment-config \
--build-env npm_config_registry=http://nexus-common.apps.na45.prod.nextcle.com/repository/nodejs \
-e DATABASE_USER=todoapp \
-e DATABASE_PASSWORD=mypass \
-e DATABASE_NAME=todo \
-e DATABASE_SVC=mysql \
-e DATABASE_INIT=true \
nodejs:12~http://github.com/atulsingh0/DO288-apps#develop \
--context-dir=todo-backend

oc set env dc/backend --from=configmap/todoapp --prefix=DATABASE_
oc set env dc/backend --from=secret/tododb --prefix=DATABASE_

oc rollout latest dc/backend



# LAB 3
# -----------------------

oc new-app --name=todoapp \
--template=todoapp \
-p DATABASE_IMAGE=registry.access.redhat.com/rhscl/mysql-57-rhel7 \
-p BACK_END_REPO=http://github.com/atulsingh0/DO288-apps \
-p BACK_END_CTXDIR=todo-backend \
-p NPM_PROXY=http://nexus-common.apps.na45.prod.nextcle.com/repository/nodejs \
-p SECRET=atul1234 \
-p PASSWORD=redhat \
-p HOSTNAME=todoui-me-lab.apps.na45.prod.nextcle.com \
-p BACKEND=todoapi-me-lab.apps.na45.prod.nextcle.com \
-p CLEAN_DATABASE=true



# -------------------------
# LAB 1 & LAB2 again 



oc create secret docker-registry quayio \
--docker-server=quay.io \
--docker-username=atulsingh0 \
--docker-password='V!sual@11'

oc secrets link builder quayio --for=pull
oc secrets link default quayio --for=pull

oc import-image todo-frontend:latest --from=quay.io/atulsingh0/front-end:latest \
--reference-policy=local \
--confirm


oc policy add-role-to-group system:image-puller system:serviceaccounts:me-dev -n me-lab

oc project me-dev

oc new-app --name=todo-frontend \
--as-deployment-config \
-e BACKEND_HOST=api.example.com \
-i me-lab/todo-frontend:latest



oc new-app --name=todoapp \
--template=todoapp \
-p DATABASE_IMAGE=registry.access.redhat.com/rhscl/mysql-57-rhel7 \
-p BACK_END_REPO=http://github.com/atulsingh0/DO288-apps \
-p BACK_END_CTXDIR=todo-backend \
-p NPM_PROXY=http://nexus-common.apps.na45.prod.nextcle.com/repository/nodejs \
-p SECRET=atul1234 \
-p PASSWORD=redhat \
-p HOSTNAME=todoui-me-dev.apps.na45.prod.nextcle.com \
-p BACKEND=todoapi-me-dev.apps.na45.prod.nextcle.com \
-p CLEAN_DATABASE=true

oc set probe dc/backend --liveness --get-url=http://:8080/todo/api/items-count --timeout-seconds=3 --initial-delay-seconds=10
oc set probe dc/backend --readiness --get-url=http://:8080/todo/api/host --timeout-seconds=3 --initial-delay-seconds=10


oc port-forward $(oc get pods -l app=tododb -o name) 33306:3306 &
RC=$!
sleep 3
mysql -utodoapp -predhat -h127.0.0.1 -P33306  todo < todo.sql
kill -15 $RC

